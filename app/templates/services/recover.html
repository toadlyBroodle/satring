{% extends "base.html" %}
{% block title %}Verify Domain Ownership - {{ service.name }}{% endblock %}
{% block content %}

<div class="max-w-2xl">
  <div class="mb-4 text-sm">
    <a href="/services/{{ service.slug }}" class="text-green-700 hover:text-amber-400">&lt; back to {{ service.name }}</a>
  </div>

  <div class="text-amber-400 text-sm mb-1">₿ satring verify {{ service.slug }}</div>
  <h1 class="text-xl mb-4">Verify Domain Ownership</h1>

  {% if error is defined and error %}
  <div class="border border-red-500 text-red-400 p-3 mb-4 text-sm">{{ error }}</div>
  {% endif %}

  {% if new_token is defined and new_token %}
  <!-- Success: show new token -->
  <div class="border border-amber-400 p-4 mb-6">
    <div class="text-amber-400 text-sm mb-2">!! Domain ownership verified !!</div>
    <p class="text-sm mb-3">Your listing now shows a <span class="text-cyan-400">[domain verified]</span> badge. Save this token — it will <span class="text-amber-400">not be shown again</span>.</p>
    <div class="flex items-center gap-2 mb-3">
      <code id="edit-token" class="bg-green-900/30 text-green-400 px-3 py-2 text-sm break-all flex-1 border border-green-800 select-all">{{ new_token }}</code>
      <button type="button" onclick="navigator.clipboard.writeText(document.getElementById('edit-token').textContent);this.textContent='[COPIED]';setTimeout(()=>this.textContent='[COPY]',1500)" class="border border-green-400 text-green-400 px-3 py-2 text-sm hover:bg-green-400 hover:text-black transition-colors whitespace-nowrap">[COPY]</button>
    </div>
    {% if domain_services is defined and domain_services|length > 1 %}
    <div class="mt-3 text-sm">
      <div class="text-green-700 mb-1">// token applied to all services on this domain:</div>
      <ul class="text-green-400 list-none space-y-1">
        {% for ds in domain_services %}
        <li><a href="/services/{{ ds.slug }}/edit?token={{ new_token }}" class="hover:text-amber-400">&gt; {{ ds.name }}</a></li>
        {% endfor %}
      </ul>
    </div>
    {% else %}
    <a href="/services/{{ service.slug }}/edit?token={{ new_token }}" class="text-green-700 hover:text-amber-400 text-sm">&gt; edit your listing now</a>
    {% endif %}
  </div>

  {% elif challenge_active %}
  <!-- Challenge generated: show instructions -->
  <div class="border border-green-800 p-4 mb-4">
    <div class="text-amber-400 text-sm mb-2">// challenge generated</div>
    <p class="text-sm mb-3">Place the following code at this URL on your service's domain:</p>
    <div class="mb-3">
      <div class="text-green-700 text-xs mb-1">URL:</div>
      <code class="bg-green-900/30 text-amber-400 px-3 py-2 text-sm block border border-green-800">{{ verify_path }}</code>
    </div>
    <div class="mb-3">
      <div class="text-green-700 text-xs mb-1">Content (plain text):</div>
      <div class="flex items-center gap-2">
        <code id="challenge-code" class="bg-green-900/30 text-green-400 px-3 py-2 text-sm break-all flex-1 border border-green-800 select-all">{{ service.domain_challenge }}</code>
        <button type="button" onclick="navigator.clipboard.writeText(document.getElementById('challenge-code').textContent);this.textContent='[COPIED]';setTimeout(()=>this.textContent='[COPY]',1500)" class="border border-green-400 text-green-400 px-3 py-2 text-sm hover:bg-green-400 hover:text-black transition-colors whitespace-nowrap">[COPY]</button>
      </div>
    </div>
    <p class="text-green-700 text-xs mb-4">Challenge expires in 30 minutes from generation.</p>

    <form method="post" action="/services/{{ service.slug }}/recover">
      <input type="hidden" name="action" value="verify" />
      <button type="submit" class="border border-green-400 text-green-400 px-4 py-1.5 text-sm hover:bg-green-400 hover:text-black transition-colors">[VERIFY DOMAIN]</button>
    </form>
  </div>

  {% else %}
  <!-- Initial: explain process -->
  <div class="border border-green-800 p-4 mb-4">
    <div class="text-amber-400 text-sm mb-2">// domain verification</div>
    <p class="text-sm mb-3">Verify ownership of <span class="text-amber-400">{{ service.url }}</span> to earn a <span class="text-cyan-400">[verified]</span> badge and get your edit token.</p>
    <ol class="text-sm text-green-700 mb-4 list-decimal list-inside space-y-1">
      <li>Click "Generate Challenge" to create a verification code</li>
      <li>Place the code at <code>{{ verify_path }}</code></li>
      <li>Click "Verify Domain" to complete verification</li>
    </ol>

    <form method="post" action="/services/{{ service.slug }}/recover">
      <input type="hidden" name="action" value="generate" />
      <button type="submit" class="border border-green-400 text-green-400 px-4 py-1.5 text-sm hover:bg-green-400 hover:text-black transition-colors">[GENERATE CHALLENGE]</button>
    </form>
  </div>
  {% endif %}
</div>

{% endblock %}
