{% extends "base.html" %}
{% block title %}Edit {{ service.name }}{% endblock %}
{% block content %}

<div class="max-w-2xl">
  <div class="mb-4 text-sm">
    <a href="/services/{{ service.slug }}" class="text-green-700 hover:text-amber-400">&lt; back to {{ service.name }}</a>
  </div>

  <div class="text-amber-400 text-sm mb-1">₿ satring edit {{ service.slug }}</div>
  <h1 class="text-xl mb-4">Edit Service</h1>

  {% if not token_valid %}
  <!-- Token entry form -->
  {% if token_invalid is defined and token_invalid %}
  <div class="border border-red-500 text-red-400 p-3 mb-4 text-sm">Invalid edit token. Please try again.</div>
  {% endif %}
  <div class="border border-green-800 p-4 mb-4">
    <p class="text-sm mb-3">Enter your edit token to modify this listing.</p>
    <form method="get" action="/services/{{ service.slug }}/edit" class="flex items-center gap-2">
      <input type="text" name="token" placeholder="paste your edit token" required
        class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1.5 text-sm flex-1 outline-none focus:border-green-400 placeholder-green-900" />
      <button type="submit" class="border border-green-400 text-green-400 px-4 py-1.5 text-sm hover:bg-green-400 hover:text-black transition-colors">[VERIFY]</button>
    </form>
    <p class="text-green-700 text-xs mt-2">Lost your token? <a href="/services/{{ service.slug }}/recover" class="hover:text-amber-400">Verify domain ownership / recover token</a></p>
  </div>

  {% else %}
  <!-- Edit form -->
  {% if error %}
  <div class="border border-red-500 text-red-400 p-3 mb-4 text-sm">{{ error }}</div>
  {% endif %}
  <form method="post" action="/services/{{ service.slug }}/edit" class="space-y-4 text-sm">
    <input type="hidden" name="edit_token" value="{{ token }}" />

    <div>
      <label for="name" class="text-green-700 block mb-1 cursor-pointer">name&gt;</label>
      <input type="text" id="name" name="name" value="{{ service.name }}" required
        class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1.5 w-full outline-none focus:border-green-400 placeholder-green-900" />
    </div>

    <div>
      <label class="text-green-700 block mb-1">url&gt; <span class="text-green-900">(read-only)</span></label>
      <div class="text-green-700 bg-green-900/20 border border-green-900 px-2 py-1.5">{{ service.url }}</div>
    </div>

    <div>
      <label for="description" class="text-green-700 block mb-1 cursor-pointer">description&gt;</label>
      <textarea id="description" name="description" rows="4"
        class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1.5 w-full outline-none focus:border-green-400 placeholder-green-900">{{ service.description }}</textarea>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label for="protocol" class="text-green-700 block mb-1 cursor-pointer">protocol&gt;</label>
        <select id="protocol" name="protocol"
          class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1.5 w-full outline-none focus:border-green-400">
          <option value="L402" {% if service.protocol == "L402" %}selected{% endif %}>L402</option>
          <option value="X402" {% if service.protocol == "X402" %}selected{% endif %}>X402</option>
        </select>
      </div>

      <div>
        <label for="pricing_sats" class="text-green-700 block mb-1 cursor-pointer">price (sats)&gt;</label>
        <input type="number" id="pricing_sats" name="pricing_sats" value="{{ service.pricing_sats }}" min="0"
          class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1.5 w-full outline-none focus:border-green-400" />
      </div>

      <div>
        <label for="pricing_model" class="text-green-700 block mb-1 cursor-pointer">model&gt;</label>
        <select id="pricing_model" name="pricing_model"
          class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1.5 w-full outline-none focus:border-green-400">
          <option value="per-request" {% if service.pricing_model == "per-request" %}selected{% endif %}>per-request</option>
          <option value="per-minute" {% if service.pricing_model == "per-minute" %}selected{% endif %}>per-minute</option>
          <option value="per-mb" {% if service.pricing_model == "per-mb" %}selected{% endif %}>per-mb</option>
          <option value="flat" {% if service.pricing_model == "flat" %}selected{% endif %}>flat</option>
        </select>
      </div>
    </div>

    <!-- Categories -->
    {% set current_cat_ids = service.categories | map(attribute='id') | list %}
    <div>
      <label class="text-green-700 block mb-1">categories&gt; <span class="text-green-900">* (pick 1–2)</span></label>
      <div class="flex flex-wrap gap-x-4 gap-y-2" id="category-group">
        {% for cat in categories %}
        <label class="cursor-pointer flex items-center gap-1.5 hover:text-amber-400 category-label" data-tip="{{ cat.description }}">
          <input type="checkbox" name="categories" value="{{ cat.id }}" {% if (selected_category_ids is defined and selected_category_ids is not none and cat.id in selected_category_ids) or (selected_category_ids is not defined and cat.id in current_cat_ids) %}checked{% endif %} class="hidden peer category-cb" />
          <span class="peer-checked:text-amber-400 category-check"></span>
          <span class="peer-checked:text-amber-400">{{ cat.name }}</span>
        </label>
        {% endfor %}
      </div>
      <p class="text-red-400 text-xs mt-1 hidden" id="category-error">Select 1–2 categories.</p>
    </div>
    <script>
      (function() {
        const cbs = document.querySelectorAll('.category-cb');
        const err = document.getElementById('category-error');
        function enforce() {
          const checked = document.querySelectorAll('.category-cb:checked');
          cbs.forEach(cb => cb.disabled = !cb.checked && checked.length >= 2);
          err.classList.toggle('hidden', checked.length >= 1);
        }
        cbs.forEach(cb => cb.addEventListener('change', enforce));
        enforce();
        document.querySelector('form[method="post"][action*="edit"]').addEventListener('submit', function(e) {
          if (document.querySelectorAll('.category-cb:checked').length < 1) {
            e.preventDefault();
            err.classList.remove('hidden');
          }
        });
      })();
    </script>

    <div class="border-t border-green-900 pt-4 mt-4">
      <div class="text-green-700 mb-2">// provider info (optional)</div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="owner_name" class="text-green-700 block mb-1 cursor-pointer">your name&gt;</label>
        <input type="text" id="owner_name" name="owner_name" value="{{ service.owner_name }}"
          class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1.5 w-full outline-none focus:border-green-400 placeholder-green-900" />
      </div>
      <div>
        <label for="owner_contact" class="text-green-700 block mb-1 cursor-pointer">contact&gt;</label>
        <input type="text" id="owner_contact" name="owner_contact" value="{{ service.owner_contact }}"
          class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1.5 w-full outline-none focus:border-green-400 placeholder-green-900" />
      </div>
    </div>

    <div>
      <label for="logo_url" class="text-green-700 block mb-1 cursor-pointer">logo url&gt;</label>
      <input type="url" id="logo_url" name="logo_url" value="{{ service.logo_url }}"
        class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1.5 w-full outline-none focus:border-green-400 placeholder-green-900" />
    </div>

    <div class="pt-4">
      <button type="submit" class="border border-green-400 text-green-400 px-6 py-1.5 hover:bg-green-400 hover:text-black transition-colors">[SAVE CHANGES]</button>
    </div>
  </form>

  <!-- Delete section -->
  <div class="border-t border-green-900 mt-8 pt-6">
    <div class="text-sm" style="color: var(--danger-text);">// danger zone</div>
    <p class="text-sm mt-2 mb-3" style="color: var(--danger-text);">Permanently remove this service and all its ratings. This cannot be undone.</p>
    <form method="post" action="/services/{{ service.slug }}/delete"
          onsubmit="return confirm('Are you sure you want to delete {{ service.name }}? This cannot be undone.');">
      <input type="hidden" name="edit_token" value="{{ token }}" />
      <button type="submit" class="px-6 py-1.5 text-sm transition-colors"
              style="border: 1px solid var(--danger); color: var(--danger-text);"
              onmouseover="this.style.background='var(--danger)'; this.style.color='white';"
              onmouseout="this.style.background='transparent'; this.style.color='var(--danger-text)';">[DELETE SERVICE]</button>
    </form>
  </div>
  {% endif %}
</div>

{% endblock %}
