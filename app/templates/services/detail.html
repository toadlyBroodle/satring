{% extends "base.html" %}
{% block title %}{{ service.name }}{% endblock %}
{% block meta_description %}{{ service.name }} — {{ service.description[:160] if service.description else 'An L402 service on satring' }}{% endblock %}
{% block og_title %}{{ service.name }} — satring{% endblock %}
{% block og_description %}{{ service.description[:200] if service.description else 'L402 service listed on satring' }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_image %}{{ service.logo_url if service.logo_url else '/static/img/satring-logo-trans-bg.png' }}{% endblock %}
{% block twitter_title %}{{ service.name }} — satring{% endblock %}
{% block twitter_description %}{{ service.description[:200] if service.description else 'L402 service listed on satring' }}{% endblock %}
{% block twitter_image %}{{ service.logo_url if service.logo_url else '/static/img/satring-logo-trans-bg.png' }}{% endblock %}
{% block extra_head %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": {{ service.name | tojson }},
  "url": {{ service.url | tojson }},
  "description": {{ (service.description or '') | tojson }},
  "applicationCategory": "WebApplication",
  "operatingSystem": "Any"{% if service.rating_count > 0 %},
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": {{ service.avg_rating }},
    "ratingCount": {{ service.rating_count }},
    "bestRating": 5,
    "worstRating": 1
  }{% endif %}
}
</script>
{% endblock %}
{% block content %}

<div class="mb-4 text-sm flex flex-wrap gap-4">
  <a href="/" class="text-green-700 hover:text-amber-400">&lt; back to directory</a>
  <a href="/services/{{ service.slug }}/edit" class="btn-edit px-3 py-0.5">[EDIT LISTING]</a>
  {% if not service.domain_verified %}<a href="/services/{{ service.slug }}/recover" class="btn-verify px-3 py-0.5">[VERIFY DOMAIN]</a>{% endif %}
</div>

<div class="mb-4">
  <div class="text-amber-400 text-sm mb-1">₿ satring info {{ service.slug }}</div>
  <h1 class="text-xl flex items-center gap-2">{% if service.logo_url %}<img src="{{ service.logo_url }}" alt="" class="h-6 w-6 object-contain">{% endif %}{{ service.name }}</h1>
  <div class="flex items-center gap-2 mt-1 text-sm">
    <span class="text-amber-400">[{{ service.protocol }}]</span>
    {% for cat in service.categories %}
    <span class="text-green-700">#{{ cat.name }}</span>
    {% endfor %}
  </div>
</div>

{% if service.description %}
<div class="text-green-400 text-sm mb-4">{{ service.description }}</div>
{% endif %}

<!-- Service Info -->
<div class="border border-green-800 mb-4 text-sm overflow-x-auto">
  <table class="w-full">
    <tbody>
      <tr class="border-b border-green-900"><td class="text-green-700 px-3 py-1.5 w-32">endpoint</td><td class="px-3 py-1.5"><a href="{{ service.url }}" class="text-amber-400 hover:underline break-all" target="_blank">{{ service.url }}</a></td></tr>
      <tr class="border-b border-green-900"><td class="text-green-700 px-3 py-1.5">pricing</td><td class="px-3 py-1.5">{{ service.pricing_sats }} sats / {{ service.pricing_model }}</td></tr>
      <tr class="border-b border-green-900"><td class="text-green-700 px-3 py-1.5">protocol</td><td class="px-3 py-1.5">{{ service.protocol }}</td></tr>
      <tr class="border-b border-green-900"><td class="text-green-700 px-3 py-1.5">status</td><td class="px-3 py-1.5">{% if service.domain_verified %}<span class="text-cyan-400">[domain verified]</span> {% endif %}{% if service.status != 'unverified' %}<span class="{% if service.status == 'live' %}text-green-400{% elif service.status == 'confirmed' %}text-amber-400{% elif service.status == 'dead' %}text-red-500{% elif service.status == 'unknown' %}text-gray-400{% else %}text-green-700{% endif %}">{{ service.status }}</span>{% endif %}</td></tr>
      {% if service.owner_name %}<tr class="border-b border-green-900"><td class="text-green-700 px-3 py-1.5">provider</td><td class="px-3 py-1.5">{{ service.owner_name }}</td></tr>{% endif %}
      {% if service.owner_contact %}<tr class="border-b border-green-900"><td class="text-green-700 px-3 py-1.5">contact</td><td class="px-3 py-1.5">{{ service.owner_contact }}</td></tr>{% endif %}
      <tr><td class="text-green-700 px-3 py-1.5">listed</td><td class="px-3 py-1.5">{{ service.created_at.strftime('%Y-%m-%d') }}</td></tr>
    </tbody>
  </table>
</div>

<!-- Stats Box -->
{% set r_val = ("%.1f/5"|format(service.avg_rating)) if service.avg_rating else "—" %}
{% set r_count = "(" ~ service.rating_count|string ~ " review" ~ ("s" if service.rating_count != 1 else "") ~ ")" %}
{% set s_val = service.status if service.status != 'unverified' else '' %}
<div class="border border-green-800 mb-6 text-sm">
  <div class="border-b border-green-800 px-3 py-1 text-green-700 text-xs">─ stats ─</div>
  <div class="px-3 py-2 space-y-0.5">
    <div><span class="text-green-700">rating:</span> <span class="text-amber-400">{{ r_val }}</span>  {{ r_count }}</div>
    <div><span class="text-green-700">price:</span>  <span class="text-amber-400">{{ service.pricing_sats }} sats</span> / {{ service.pricing_model }}</div>
    <div><span class="text-green-700">proto:</span>  {{ service.protocol }}</div>
    <div><span class="text-green-700">status:</span> {% if service.domain_verified %}<span class="text-cyan-400">[verified]</span> {% endif %}{% if service.status != 'unverified' %}<span class="{% if service.status == 'live' %}text-green-400{% elif service.status == 'confirmed' %}text-amber-400{% elif service.status == 'dead' %}text-red-500{% elif service.status == 'unknown' %}text-gray-400{% else %}text-green-700{% endif %}">{{ s_val }}</span>{% endif %}</div>
  </div>
</div>

<!-- Reviews -->
<div class="mb-6">
  <div class="text-amber-400 text-sm mb-2">## reviews ({{ service.rating_count }})</div>

  <div id="reviews">
    {% for rating in (service.ratings | sort(attribute='created_at', reverse=True))[:20] %}
      {% include "services/_review_bubble.html" %}
    {% else %}
      <p id="no-reviews" class="text-green-700 text-sm">No reviews yet. Be the first!</p>
    {% endfor %}
  </div>

  <!-- Review Form -->
  <div id="payment-area">
    <div class="border border-green-800 mt-4 p-4">
      <div class="text-amber-400 text-sm mb-3">₿ satring review --submit</div>
      {# SECURITY: maxlength values must match constants in app/config.py (server enforces the real limits) #}
      <form hx-post="/services/{{ service.slug }}/rate" hx-target="#reviews" hx-swap="afterbegin" hx-on::after-request="this.reset()" hx-indicator="#review-indicator" hx-disabled-elt="#review-submit-btn">
        <div class="mb-3">
          <label for="reviewer_name" class="text-green-700 text-sm block mb-1 cursor-pointer">name&gt;</label>
          <input type="text" id="reviewer_name" name="reviewer_name" maxlength="200" placeholder="Anonymous"
            class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1 text-sm w-full max-w-xs outline-none focus:border-green-400 placeholder-green-900" />
        </div>
        <div class="mb-3">
          <label class="text-green-700 text-sm block mb-1">score&gt;</label>
          <div class="flex gap-3 text-sm">
            {% for i in range(1, 6) %}
            <label class="cursor-pointer hover:text-amber-400">
              <input type="radio" name="score" value="{{ i }}" {% if i == 3 %}checked{% endif %} class="hidden peer" />
              <span class="peer-checked:text-amber-400 peer-checked:font-bold">[{{ i }}]</span>
            </label>
            {% endfor %}
          </div>
        </div>
        <div class="mb-3">
          <label for="comment" class="text-green-700 text-sm block mb-1 cursor-pointer">comment&gt;</label>
          <textarea id="comment" name="comment" rows="3" maxlength="2000" placeholder="What did you think?"
            class="bg-black text-green-400 border border-green-800 rounded-none px-2 py-1 text-sm w-full outline-none focus:border-green-400 placeholder-green-900"></textarea>
        </div>
        <button type="submit" id="review-submit-btn" class="btn-action px-4 py-1 text-sm">[SUBMIT]</button>
        <span id="review-indicator" class="htmx-indicator text-amber-400 text-sm ml-2">submitting<span class="blink">_</span></span>
      </form>
    </div>
  </div>
</div>

{% endblock %}
