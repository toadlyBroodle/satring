{% extends "base.html" %}
{% block title %}Directory{% endblock %}
{% block content %}

<div class="mb-4">
  <div class="text-amber-400 text-sm mb-1">â‚¿ satring --list</div>
  <h1 class="text-xl">L402 Service Directory</h1>
  <p class="text-green-700 text-sm">Discover Lightning-paywalled APIs for your AI agents</p>
</div>

<!-- Query string helpers -->
{% set qs_sort = '&sort=' ~ active_sort if active_sort and active_sort != 'newest' else '' %}
{% set qs_cat = '&category=' ~ active_category if active_category else '' %}
{% set qs_filter = '&verified=true' if active_verified == 'true' else ('&status=' ~ active_status if active_status else '') %}
{% set qs_cat_filter = ('category=' ~ active_category if active_category else '') ~ (('&' if active_category else '') ~ qs_filter[1:] if qs_filter else '') %}
{% set qs_base = qs_cat_filter ~ (('&' if qs_cat_filter else '') ~ 'sort=' ~ active_sort if active_sort and active_sort != 'newest' else '') %}

<!-- Search -->
<div class="mb-4">
  <div class="flex items-center border border-green-800 rounded-none max-w-full sm:max-w-md">
    <label for="search" class="text-green-700 pl-2 text-sm cursor-pointer">search&gt;</label>
    <input type="text" id="search" name="q" placeholder="_"
      class="bg-black text-green-400 border-none outline-none w-full px-2 py-1.5 text-sm placeholder-green-900"
      hx-get="/search?{{ qs_base }}" hx-trigger="input changed delay:300ms" hx-target="#service-grid" />
  </div>
</div>

<!-- Category Filters -->
<div class="mb-2 flex flex-wrap gap-2 text-sm">
  <span class="text-green-700 py-0.5">cat&gt;</span>
  <a href="/?{{ qs_filter[1:] if qs_filter else '' }}{{ qs_sort }}" class="border border-green-800 px-2 py-0.5 {% if not active_category %}bg-green-400 text-black{% else %}hover:text-amber-400{% endif %}">[all]</a>
  {% for cat in categories %}
  <a href="/?category={{ cat.slug }}{{ qs_filter }}{{ qs_sort }}" data-tip="{{ cat.description }}" class="border border-green-800 px-2 py-0.5 {% if active_category == cat.slug %}bg-amber-400 text-black{% else %}hover:text-amber-400{% endif %}">[{{ cat.name }}]</a>
  {% endfor %}
</div>

<!-- Status Filters -->
<div class="mb-2 flex flex-wrap gap-2 text-sm">
  <span class="text-green-700 py-0.5">filter&gt;</span>
  <a href="/?{{ ('category=' ~ active_category) if active_category else '' }}{{ qs_sort }}" class="border border-green-800 px-2 py-0.5 {% if not active_status and active_verified != 'true' %}bg-green-400 text-black{% else %}hover:text-amber-400{% endif %}">[all]</a>
  <a href="/?verified=true{{ qs_cat }}{{ qs_sort }}" data-tip="Owner proved domain control" class="filter-verified border border-green-800 px-2 py-0.5 {% if active_verified == 'true' %}active{% else %}hover:text-amber-400{% endif %}">[verified]</a>
  {% set status_tips = {'confirmed': 'L402 paywall detected by probe', 'live': 'Endpoint reachable, no L402 paywall found', 'dead': 'Endpoint unreachable'} %}
  {% for st in ['confirmed', 'live', 'dead'] %}
  <a href="/?status={{ st }}{{ qs_cat }}{{ qs_sort }}" data-tip="{{ status_tips[st] }}" class="border border-green-800 px-2 py-0.5 {% if active_status == st %}bg-amber-400 text-black{% else %}hover:text-amber-400{% endif %}">[{{ st }}]</a>
  {% endfor %}
</div>

<!-- Sort Options -->
<div class="mb-4 flex flex-wrap gap-2 text-sm">
  <span class="text-green-700 py-0.5">sort&gt;</span>
  {% for sort_key, sort_label in [('newest', 'newest'), ('top-rated', 'top-rated'), ('cheapest', 'cheapest'), ('most-reviewed', 'most-reviewed')] %}
  <a href="/?{{ qs_cat_filter }}{{ ('&' if qs_cat_filter else '') }}sort={{ sort_key }}" class="border border-green-800 px-2 py-0.5 {% if active_sort == sort_key or (sort_key == 'newest' and not active_sort) %}bg-green-400 text-black{% else %}hover:text-amber-400{% endif %}">[{{ sort_label }}]</a>
  {% endfor %}
</div>

<!-- Service List -->
<div id="service-grid" class="flex flex-col gap-2">
  {% for service in services %}
    {% include "services/_card.html" %}
  {% else %}
    <div class="border border-green-900 py-8 text-center text-green-700">
      <p>No services found.</p>
      <a href="/submit" class="text-amber-400 hover:underline mt-2 inline-block">&gt; [submit the first one]</a>
    </div>
  {% endfor %}
</div>

{% endblock %}
