<div class="border border-amber-400 p-4 mt-4">
  <div class="text-amber-400 text-sm mb-3">â‚¿ lightning-pay --invoice</div>
  <p class="text-green-400 text-sm mb-3">Pay <span class="text-amber-400">{{ amount_sats }} sats</span> to continue</p>

  <!-- QR Code -->
  <div class="flex justify-center mb-3">
    <canvas id="qr-canvas" class="border border-green-800"></canvas>
  </div>

  <!-- BOLT11 string -->
  <div class="mb-3">
    <label class="text-green-700 text-xs block mb-1">BOLT11 invoice&gt;</label>
    <div class="flex gap-2 items-start">
      <code id="bolt11-str" class="bg-black text-green-400 border border-green-800 px-2 py-1 text-xs break-all block flex-1 max-h-20 overflow-y-auto">{{ payment_request }}</code>
      <button onclick="navigator.clipboard.writeText(document.getElementById('bolt11-str').textContent)" class="border border-green-400 text-green-400 px-2 py-1 text-xs hover:bg-green-400 hover:text-black transition-colors whitespace-nowrap">[COPY]</button>
    </div>
  </div>

  <!-- Status -->
  <div id="payment-status" class="text-sm">
    <span class="text-green-700">status&gt;</span>
    <span id="status-text" class="text-amber-400">waiting for payment...</span>
  </div>

  <!-- Hidden form fields for resubmission -->
  {% for key, value in form_fields.items() %}
  <input type="hidden" class="payment-field" name="{{ key }}" value="{{ value }}" />
  {% endfor %}

  <script>
    (function() {
      // Render QR code
      if (typeof QRious !== 'undefined') {
        new QRious({
          element: document.getElementById('qr-canvas'),
          value: '{{ payment_request }}',
          size: 200,
          foreground: '#4ade80',
          background: '#000000',
          level: 'L',
        });
      }

      var paymentHash = '{{ payment_hash }}';
      var formAction = '{{ form_action }}';
      var htmxMode = {{ 'true' if htmx_mode else 'false' }};
      {% if htmx_mode %}
      var slug = '{{ slug }}';
      {% endif %}

      // Collect form field values
      function getFormValues() {
        var fields = document.querySelectorAll('.payment-field');
        var values = {};
        fields.forEach(function(f) { values[f.name] = f.value; });
        return values;
      }

      // Poll for payment (stop after 10 minutes)
      var pollErrors = 0;
      var pollInterval = setInterval(function() {
        if (pollErrors > 120) {
          clearInterval(pollInterval);
          document.getElementById('status-text').textContent = 'invoice expired. please refresh and try again.';
          document.getElementById('status-text').className = 'text-red-400';
          return;
        }
        fetch('/payment-status/' + paymentHash)
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.paid) {
              clearInterval(pollInterval);
              document.getElementById('status-text').textContent = 'paid! submitting...';
              document.getElementById('status-text').className = 'text-green-400';

              if (htmxMode) {
                // HTMX review flow: resubmit then reload to update stats
                var values = getFormValues();
                htmx.ajax('POST', formAction + '?payment_hash=' + paymentHash, {
                  target: '#reviews',
                  swap: 'afterbegin',
                  values: values,
                }).then(function() {
                  window.location.reload();
                }).catch(function() {
                  window.location.reload();
                });
              } else {
                // Full-page flow: build and submit a form
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = formAction + '?payment_hash=' + paymentHash;
                var values = getFormValues();
                for (var key in values) {
                  var input = document.createElement('input');
                  input.type = 'hidden';
                  input.name = key;
                  // Handle category fields specially
                  if (key.startsWith('categories_')) {
                    input.name = 'categories';
                  }
                  input.value = values[key];
                  form.appendChild(input);
                }
                document.body.appendChild(form);
                form.submit();
              }
            }
          })
          .catch(function() { pollErrors += 10; });
        pollErrors++;
      }, 5000);
    })();
  </script>
</div>
